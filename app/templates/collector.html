{% extends "base.html" %}
{% block content %}
  <link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}"/>
<div class="row">
    <div class="col-md-5">
      <div class="page-header">
        <h1>{{ collector['collector_name'] }}</h1>
        <h4><em>
          {% if active_status == 'active' %}
            Active
          {% else %}
            Inactive
          {% endif %}
        </em></h4>

        <a class="btn btn-default" href="{{ url_for('update_collector', collector_id=collector['_id']) }}">Edit Collector</a>
      </div><!-- /.page-header -->

      <!-- Network -->
      <div class="row">
        <div class="col-sm-4"><strong>Network</strong></div>
        <div class="col-sm-8">{{ collector['network'] }}</div>
      </div>

      <!-- Collection Type -->
      <div class="row">
        <div class="col-sm-4"><strong>Collection Type</strong></div>
        <div class="col-sm-8">{{ collector['collection_type'] }}</div>
      </div>

      <br />
	

 <div class="row">
        <div class="col-sm-4"><strong>Collector Terms</strong></div>
        <div class="col-sm-8" id="termvalues"></div>
      </div>


	<br/>
      <!-- Start & End Date -->
      <div class="row">
        <div class="col-sm-4"><strong>Start Date</strong></div>
        <div class="col-sm-8">
          {% if collector['start_date'] %}
            {{ collector['start_date'] }}
          {% else %}
            None
          {% endif %}
        </div>
      </div>
      <div class="row">
        <div class="col-sm-4"><strong>End Date</strong></div>
        <div class="col-sm-8">
          {% if collector['end_date'] %}
            {{ collector['end_date'] }}
          {% else %}
            None
          {% endif %}
        </div>
      </div>

      <!-- Twitter specific features -->
      {% if collector['network'] == 'twitter' %}
        <br />

        <!-- API Filter -->
        <div class="row">
          <div class="col-sm-4"><strong>API Filter</strong></div>
          <div class="col-sm-8">
            {% if collector['api'] %}
              {{ collector['api'] }}
            {% else %}
              None
            {% endif %}
          </div>
        </div>

        <!-- Languages -->
        <div class="row">
          <div class="col-sm-4"><strong>Languages</strong></div>
          <div class="col-sm-8">
            {% if collector['languages'] %}
              {% for lang in collector['languages'] %}
                {{ lang }},
              {% endfor %}
            {% else %}
              None
            {% endif %}
          </div>
        </div>

        <!-- Locations -->
        <div class="row">
          <div class="col-sm-4"><strong>Locations</strong></div>
          <div class="col-sm-8">
            {% if collector['locations'] %}
              {{ collector['locations'] }}
            {% else %}
              None
            {% endif %}
          </div>
        </div>
      {% endif %}

      <hr />

      {% if task_status %}
        <div class="alert alert-warning alert-dismissable" role="alert">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          {{  task_status  }}
        </div>
      {% endif %}

      <form method="POST" action="/collector_control/{{collector['_id']}}" class="form">
        {{ form.csrf_token }}
        <input type="submit" name="control" value="Start" class="btn btn-default">
        <input type="submit" name="control" value="Stop" class="btn btn-default">
        <input type="submit" name="control" value="Restart" class="btn btn-default">
      </form>
    </div>
<br>
 <img src="/static/images.png" style="height:auto;width:30px"></img>
<input type="text" id="searchterm" onkeyup="search()" placeholder="Search for Terms.."  class="col-sm-2">

    
<!-- Terms Table -->
    <div class="col-md-7">
      <h3>Collector Terms</h3>

      {% if collector['terms_list'] %}

        <table id="showtable" class="table">
          <thead>
            <tr>
              <th>Term</th>
              <th>Type</th>
              <th>Collecting</th>
              <th>Start / Stop Dates</th>
              <th>Term ID</th>
            </tr>
          </thead>

          {% for term in collector['terms_list'] %}
            <tr >
              <td  class="termname" id={{term['id']}} onclick="ShowContent(this.id)">{{ term['term'] }}</td>
              <td >{{ term['term'] }}</td>
              <td>
                {% if term['collect'] == 1 %}
                  Yes
                {% else %}
                  No
                {% endif %}
              </td>
              <td>
                {% for range in term['history'] %}
                  {{ range['start_date'] }} -- {{ range['end_date'] }}<br />
                {% endfor %}
              </td>
              <td>
                {% if term['id'] %}
                  {{ term['id'] }}
                {% else %}
                  None
                {% endif %}
              </td>

            </tr>
          {% endfor %}
<tr >
<span id="notermmsg" style="display:none">
No Terms Found</span>
</tr>
</table>

      {% else %}
        No Terms
      {% endif %}
    </div>
  </div>



<div class="loader" id="loader" style="top:80%;left:43%;position:absolute;display:none"></div>

<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header" id="modalheader">
      <span id="closemodel" onclick="closemodel()" class="close">&times;</span>
      <h2 id="header"></h2>

<ul class="nav nav-tabs" id="tabs">
    <li id="tweetsto" class="active col-sm-6"><a style="cursor:pointer;color:black" onclick="switchTab(1)"><span>TWEETS TO TERM</span></a></li>
 <li  id="tweetsby" class="col-sm-6"><a style="cursor:pointer;color:black" onclick="switchTab(2)"><span>TWEETS BY TERM</span></a></li>
        	

</ul>


    </div>
<span style="display:none;left:50%;top:-4%;position:relative" id="pagenum"></span>
    <div class="modal-body" id="putdata">
      <p></p>
      <p></p>
    </div>
   
<div class="modal-body" id="usertweets" style="display:none">
      <p></p>
      <p></p>
    </div>

<button id="tweetsdisplay" class="databutton" value="" text="1"  onclick="showtweets()"><span>View Content</span></button>

  </div>

</div>


<script>
var tabstatus=1;
var totalcols = document.getElementById('showtable').getElementsByTagName("td").length;
var entries = 0;
var rows = document.getElementById('showtable').rows[0].cells.length;
if (rows != 0)
    entries = totalcols / rows;

document.getElementById("termvalues").innerHTML = entries;
document.getElementById("notermmsg").style.display = "none";
var terms = document.getElementsByClassName('termname');
document.getElementById("searchterm").value = "";
var searchterm = "";
var i = 0,
    flag = 1;

function search() {
    flag = 1;
    searchterm = document.getElementById("searchterm").value;
    for (i = 0; i < terms.length; i++) {
        terms[i].parentElement.style.display = "";
        if (!terms[i].innerHTML.includes(searchterm)) {
            terms[i].parentElement.style.display = "none";
        } else {
            flag = 0;
        }

    }
    if (flag == 1) {
        document.getElementById("notermmsg").style.display = "block";
    } else
        document.getElementById("notermmsg").style.display = "none";
}


/*method in views.py*/
function ShowContent(termid)

{
    try {
        modal.style.display = "block";
	document.getElementById("tabs").style.display="none";
        document.getElementById("tweetsdisplay").style.display = "block";
        document.getElementById("pagenum").style.display = "none";
        document.getElementById("tweetsdisplay").value = termid;
        document.getElementById("loader").style.display = "block";
        document.getElementById("putdata").innerHTML = "";
        /*checks to see if termid is blank,in that case please check config db*/

        if (termid == "None") {
            document.getElementById("header").innerHTML = "";
            document.getElementById("modalheader").style.backgroundColor = "#EE0000";
            document.getElementById("putdata").innerHTML = "TermId is blank,check config DB";
            document.getElementById("tweetsdisplay").style.display = "none";
            document.getElementById("loader").style.display = "none";
        } else {

            $.ajax({
                type: "GET",
                url: "/display_termsvalue/{{projectid}}/{{project_name}}/{{network}}/{{collector['collector_name']}}/{{collector['_id']}}/0/0/0/" + termid,

                success: function(result) {
                    document.getElementById("loader").style.display = "none";
                    res = JSON.parse(result);
                    if (res.message == "Failed") {

                        //information=res.reason;
                        document.getElementById("modalheader").style.backgroundColor = "#EE0000";
                        information = res.reason;
                        document.getElementById("header").innerHTML = "";
                    } else {
                        information = "<b>Name:</b>" + res.names +
                            "<br> <b> Description </b>: " + res.description + "<br>" +
                            "<b>Friend Count</b>: " + res.friends_count +
                            "<br><b>Location:</b>" + res.location +
                            "<br><b>Favourite Count:</b>" + res.favouritecount +
                            "<br><b>Status Count:</b>" + res.statuscount +
                            "<br><b>Followers:</b>" + res.followers + "<br><b>Total URLS:</b>" + res.totalurls +
                            "<br><b>Total Tweets with Hashtags:</b>" + res.hashtagscounter +
                            "<br><b>Total Tweets with exclamation :</b>" + res.tweets_with_exclaim +
                            "<br><b>Total Tweets with User mentions :</b>" + res.tweets_user_mentions +
                            "<br><b>Total Tweets with Re-tweeted :</b>" + res.total_retweets;
                        document.getElementById("header").style.color = "#" + res.headercolor;
                        document.getElementById("header").innerHTML = res.names;
                        document.getElementById("modalheader").style.backgroundColor = "#5cb85c";
                    }
                    /*sets time to fetch tweets ,all tweets must be after epoch time*/
                    SetPageandDateDefault();
                    document.getElementById("putdata").innerHTML = information;
                }

            });
        }
    } catch (e) {}

}


function SetPageandDateDefault() {
    localStorage.setItem("createdts", "1970-01-01T00:00:00Z");
    localStorage.setItem("setpagenumber", "0");
}

function switchTab(tabnumber) {
    SetPageandDateDefault();
    tabstatus=tabnumber;
if(tabnumber==1)
{
$("#tweetsby").removeClass("active");
$("#tweetsto").addClass("active");
}
else{
$("#tweetsto").removeClass("active");
$("#tweetsby").addClass("active");
	}
    showtweets(tabnumber)
}

function showtweets(tabnumber=tabstatus)

{
    try {
	document.getElementById("tabs").style.display="block";
        termid = document.getElementById("tweetsdisplay").value;
        document.getElementById("loader").style.display = "block";
        document.getElementById("putdata").innerHTML = "";
        createdts = localStorage.getItem("createdts");
        //alert(localStorage.getItem("terms"));
        $.ajax({
            type: "GET",
            url: "/display_termsvalue/{{projectid}}/{{project_name}}/{{network}}/{{collector['collector_name']}}/{{collector['_id']}}/1/" + createdts + "/"+tabnumber+"/" + termid,

            success: function(result) {
                document.getElementById("pagenum").style.display = "block";
                document.getElementById("loader").style.display = "none";
                modal.style.display = "block";
                res = JSON.parse(result);
                var information = "<br>";
                var usertweetinfo = "<br><b>----Tweets by---------" + document.getElementById("header").innerHTML + "----</b><br>";
                //document.getElementById("header").innerHTML="";
                if (res.message == "Failed") {
                    information = res.reason;
                    //information=res.reason;
                    document.getElementById("modalheader").style.backgroundColor = "#EE0000";
                    document.getElementById("header").innerHTML = "";
                } else {
                    var pagenum = parseInt(localStorage.getItem("setpagenumber"));
                    pagenum = pagenum + 1;
                    var tweets = res.tweets.split("||");
                    var users = res.users.split("||");
                    if (tabnumber == 1) {
                        for (var i = 1; i < tweets.length; i++) {
                            information = information + "<b>" + users[i] + " :</b>" + tweets[i] + "<br>";
                        }
                    } else {
                        for (var i = 1; i < tweets.length; i++) {
                            information = information + tweets[i] + "<br>";
                        }

                    }

                }
                //alert(res.createdts);
                if (tweets.length <= 20) {
                    localStorage.setItem("createdts", "1970-01-01T00:00:00Z");
                    localStorage.setItem("setpagenumber", 0);

                } else
                    localStorage.setItem("createdts", res.createdts);
                document.getElementById("putdata").innerHTML = information;
                document.getElementById("pagenum").innerHTML = "<b>Page: " + pagenum + "</b>";
                if (tweets.length <= 20)
                    pagenum = 0;
                localStorage.setItem("setpagenumber", pagenum);
            }

        });
    } catch (e) {}
}
</script>

{% endblock %}


